<!-- lecture_watch.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ê°•ì˜ ì˜ìƒ ë³´ê¸°</title>

  <!-- ê³µí†µ head í”„ë˜ê·¸ë¨¼íŠ¸ -->
  <th:block th:insert="~{layout :: head}"></th:block>

  <!-- í˜ì´ì§€ ì „ìš© CSS (ê³µí†µë³´ë‹¤ ë’¤ìª½) -->
  <style>
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìƒ‰ìƒ ë³€ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :root{
      --bs-primary:#337ab7;
      --bs-primary-dark:#2e6da4;
      --bs-danger:#e74c3c;
      --bs-danger-dark:#c0392b;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë ˆì´ì•„ì›ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    html,body{height:100%;margin:0;display:flex;flex-direction:column;background:#f9f9fb;font-family:Arial,Helvetica,sans-serif}
    .fixed-header{flex:0 0 auto;background:#f9f9f9;padding:16px 20px;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .video-container{position:relative;width:800px;margin:0 auto}
    .marker-overlay{position:absolute;bottom:30px;left:0;width:100%;height:8px;pointer-events:none}
    .marker{position:absolute;width:8px;height:8px;background:lime;border:1px solid darkgreen;border-radius:50%;cursor:pointer;pointer-events:auto}
    .scroll-content{flex:1 1 auto;overflow-y:auto;padding:20px;background:#fff;display:none} /* â†“ í† ê¸€ í‘œì‹œìš© */
    .scroll-content section{margin-bottom:24px}
    table{width:100%;border-collapse:collapse}
    table th,table td{border:1px solid #ccc;padding:6px;text-align:center}
    table thead th{background:var(--bs-primary);color:#fff}

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë²„íŠ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn{
      border:none;
      border-radius:4px;
      padding:6px 12px;
      cursor:pointer;
      font-weight:600;
      transition:background-color .2s,color .2s
    }
    .btn-primary{
      background:var(--bs-primary);
      color:#fff
    }
    .btn-primary:hover{background:var(--bs-primary-dark)}
  </style>
</head>

<body>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìƒë‹¨ ê³ ì •: ë¹„ë””ì˜¤ + ê²€ìƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="fixed-header">
  <h1>ê°•ì˜ ì˜ìƒ ë³´ê¸°</h1>

  <div class="video-container">
    <video id="videoPlayer" width="800" controls
           th:src="@{/uploads/{file}(file=${video.videoPath})}"
           th:attr="data-video-no=${video.videoNo}"
           onloadedmetadata="initResume()"
           ontimeupdate="reportProgress()">
      ë¸Œë¼ìš°ì €ê°€ video íƒœê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    </video>
    <div id="markerOverlay" class="marker-overlay"></div>
  </div>

  <!-- ğŸ” í‚¤ì›Œë“œ ê²€ìƒ‰ -->
  <section style="margin-top:14px;">
    <h2>í‚¤ì›Œë“œ ê²€ìƒ‰</h2>
    <input type="text" id="keywordInput" placeholder="ê²€ìƒ‰í•  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
    <button type="button" class="btn btn-primary" onclick="searchKeyword()">ê²€ìƒ‰</button>
    <div id="searchResults" style="margin-top:10px;max-height:100px;overflow-y:auto;"></div>
  </section>

  <!-- ì¶”ê°€ ì •ë³´ í† ê¸€ -->
  <button id="toggleInfoBtn" type="button" class="btn btn-primary" style="margin-top:16px;" onclick="toggleInfo()">
    ì¶”ê°€ ì •ë³´ ë³´ê¸°
  </button>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì¶”ê°€ ì •ë³´ ì˜ì—­ (ì´ˆê¸° ìˆ¨ê¹€) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="infoSection" class="scroll-content">
  <section>
    <h4>ìš”ì•½</h4>
    <pre th:text="${summary}"
         style="max-height:200px;overflow-y:auto;border:1px solid #ccc;
                padding:12px;white-space:pre-wrap;"></pre>
  </section>

  <section>
    <h4>ìë™ ì¶”ì¶œ ì›ë¬¸</h4>
    <pre th:text="${video.rawText}"
         style="max-height:220px;overflow-y:auto;border:1px solid #ccc;
                padding:12px;white-space:pre-wrap;"></pre>
  </section>

  <section>
    <h4>ìƒìœ„ 10ê°œ Keyword</h4>
    <ul>
      <li th:each="pair : ${topKeywords}"
          th:text="${pair[0]} + ' : ' + ${pair[1]}">í‚¤ì›Œë“œ : ë¹ˆë„</li>
    </ul>
  </section>

  <section>
    <h2>â±ï¸ ì„¸ê·¸ë¨¼íŠ¸ë³„ ìë§‰</h2>
    <table>
      <thead>
        <tr><th>ìˆœë²ˆ</th><th>ì‹œì‘</th><th>ë</th><th>ìë§‰</th><th>ì¬ìƒ</th></tr>
      </thead>
      <tbody>
      <tr th:each="seg,stat : ${segments}">
        <td th:text="${stat.index+1}">1</td>
        <td th:text="${seg.start}">0.0</td>
        <td th:text="${seg.end}">5.2</td>
        <td th:text="${seg.text}">ìë§‰</td>
        <td><button type="button" class="btn btn-primary" th:onclick="'videoSeek('+${seg.start}+')';">â–¶ï¸</button></td>
      </tr>
      </tbody>
    </table>
  </section>

  <p><a th:href="@{/lecture/upload}">ë‹¤ì‹œ ì—…ë¡œë“œ</a></p>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  JS: ì§„ë„/ê²€ìƒ‰/í† ê¸€/ë§ˆì»¤  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script th:inline="javascript">
/*<![CDATA[*/
const segments   = /*[[${segments}]]*/ [];
const savedPct   = /*[[${videoPct}]]*/ 0;
const video      = document.getElementById('videoPlayer');
const overlay    = document.getElementById('markerOverlay');
const videoNo    = Number(video.dataset.videoNo);
const infoSec    = document.getElementById('infoSection');
const toggleBtn  = document.getElementById('toggleInfoBtn');
let infoVisible  = false;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì •ë³´ í† ê¸€ â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleInfo(){
  infoVisible = !infoVisible;
  infoSec.style.display = infoVisible ? 'block' : 'none';
  toggleBtn.textContent = infoVisible ? 'ì¶”ê°€ ì •ë³´ ìˆ¨ê¸°ê¸°' : 'ì¶”ê°€ ì •ë³´ ë³´ê¸°';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì¬ìƒ ìœ„ì¹˜ ë³µì› â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initResume(){
  if(savedPct>0 && video.duration){
    let resumeTime = video.duration*savedPct/100;
    if(resumeTime>video.duration) resumeTime = video.duration-0.5;
    video.currentTime = resumeTime;
  }
}

/* ê³µí†µ fetch í•¨ìˆ˜ */
function sendProgress(pct){
  fetch('/api/progress/save',{method:'POST',headers:{'Content-Type':'application/json'},
         body:JSON.stringify({videoNo,progress:pct})}).catch(console.error);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì§„í–‰ë¥  ì „ì†¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastSentTime = 0;
const intervalSec = 5;
function reportProgress(){
  if(!video.duration) return;
  const now = video.currentTime;
  if(now - lastSentTime < intervalSec) return;

  const pct = Math.floor(now/video.duration*100);
  lastSentTime = now;
  sendProgress(pct);

  if(pct>=99){ sendProgress(100); }
}

// ì¬ìƒ ì™„ë£Œ ì‹œ 100% ì €ì¥
video.addEventListener('ended', ()=> sendProgress(100));

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì‹œí‚¹/ë§ˆì»¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€
function videoSeek(t){ video.currentTime=t; video.play(); }
function clearMarkers(){ overlay.innerHTML=''; }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ í‚¤ì›Œë“œ ê²€ìƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€
function searchKeyword(){
  const kw = document.getElementById('keywordInput').value.trim().toLowerCase();
  const resDiv = document.getElementById('searchResults');
  resDiv.innerHTML=''; clearMarkers();

  if(!kw){ resDiv.textContent='ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; return; }

  let found=0;
  segments.forEach((seg,i)=>{
    const txt = (seg.text||'').toLowerCase();
    if(txt.includes(kw)){
      found++;
      const row = document.createElement('div'); row.style.marginBottom='8px';
      const btn = document.createElement('button'); btn.className='btn btn-primary';
      btn.textContent=`${i+1}ë²ˆ (${seg.start.toFixed(1)}s)`;
      btn.onclick=()=>videoSeek(seg.start);
      row.appendChild(btn);
      row.append(`  ${seg.text}`);
      resDiv.appendChild(row);

      const dur = video.duration||1;
      const marker = document.createElement('div'); marker.className='marker';
      marker.style.left=`calc(${(seg.start/dur)*100}% - 4px)`;
      marker.title=seg.text;
      marker.onclick=()=>videoSeek(seg.start);
      overlay.appendChild(marker);
    }
  });
  if(!found) resDiv.textContent='í•´ë‹¹ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.';
}
/*]]>*/
</script>
</body>
</html>