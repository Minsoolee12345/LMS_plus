<!-- lecture_watch.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>강의 영상 보기</title>

  <!-- 공통 head 프래그먼트 -->
  <th:block th:insert="~{layout :: head}"></th:block>

  <!-- 페이지 전용 CSS (공통보다 뒤쪽) -->
  <style>
    /* ───────── 색상 변수 ───────── */
    :root{
      --bs-primary:#337ab7;
      --bs-primary-dark:#2e6da4;
      --bs-danger:#e74c3c;
      --bs-danger-dark:#c0392b;
    }

    /* ───────── 레이아웃 ───────── */
    html,body{height:100%;margin:0;display:flex;flex-direction:column;background:#f9f9fb;font-family:Arial,Helvetica,sans-serif}
    .fixed-header{flex:0 0 auto;background:#f9f9f9;padding:16px 20px;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .video-container{position:relative;width:800px;margin:0 auto}
    .marker-overlay{position:absolute;bottom:30px;left:0;width:100%;height:8px;pointer-events:none}
    .marker{position:absolute;width:8px;height:8px;background:lime;border:1px solid darkgreen;border-radius:50%;cursor:pointer;pointer-events:auto}
    .scroll-content{flex:1 1 auto;overflow-y:auto;padding:20px;background:#fff;display:none} /* ↓ 토글 표시용 */
    .scroll-content section{margin-bottom:24px}
    table{width:100%;border-collapse:collapse}
    table th,table td{border:1px solid #ccc;padding:6px;text-align:center}
    table thead th{background:var(--bs-primary);color:#fff}

    /* ───────── 버튼 ───────── */
    .btn{
      border:none;
      border-radius:4px;
      padding:6px 12px;
      cursor:pointer;
      font-weight:600;
      transition:background-color .2s,color .2s
    }
    .btn-primary{
      background:var(--bs-primary);
      color:#fff
    }
    .btn-primary:hover{background:var(--bs-primary-dark)}
  </style>
</head>

<body>

<!-- ───────────────────────── 상단 고정: 비디오 + 검색 ───────────────────────── -->
<div class="fixed-header">
  <h1>강의 영상 보기</h1>

  <div class="video-container">
    <video id="videoPlayer" width="800" controls
           th:src="@{/uploads/{file}(file=${video.videoPath})}"
           th:attr="data-video-no=${video.videoNo}"
           onloadedmetadata="initResume()"
           ontimeupdate="reportProgress()">
      브라우저가 video 태그를 지원하지 않습니다.
    </video>
    <div id="markerOverlay" class="marker-overlay"></div>
  </div>

  <!-- 🔍 키워드 검색 -->
  <section style="margin-top:14px;">
    <h2>키워드 검색</h2>
    <input type="text" id="keywordInput" placeholder="검색할 키워드를 입력하세요">
    <button type="button" class="btn btn-primary" onclick="searchKeyword()">검색</button>
    <div id="searchResults" style="margin-top:10px;max-height:100px;overflow-y:auto;"></div>
  </section>

  <!-- 추가 정보 토글 -->
  <button id="toggleInfoBtn" type="button" class="btn btn-primary" style="margin-top:16px;" onclick="toggleInfo()">
    추가 정보 보기
  </button>
</div>

<!-- ───────────────────────── 추가 정보 영역 (초기 숨김) ───────────────────────── -->
<div id="infoSection" class="scroll-content">
  <section>
    <h4>요약</h4>
    <pre th:text="${summary}"
         style="max-height:200px;overflow-y:auto;border:1px solid #ccc;
                padding:12px;white-space:pre-wrap;"></pre>
  </section>

  <section>
    <h4>자동 추출 원문</h4>
    <pre th:text="${video.rawText}"
         style="max-height:220px;overflow-y:auto;border:1px solid #ccc;
                padding:12px;white-space:pre-wrap;"></pre>
  </section>

  <section>
    <h4>상위 10개 Keyword</h4>
    <ul>
      <li th:each="pair : ${topKeywords}"
          th:text="${pair[0]} + ' : ' + ${pair[1]}">키워드 : 빈도</li>
    </ul>
  </section>

  <section>
    <h2>⏱️ 세그먼트별 자막</h2>
    <table>
      <thead>
        <tr><th>순번</th><th>시작</th><th>끝</th><th>자막</th><th>재생</th></tr>
      </thead>
      <tbody>
      <tr th:each="seg,stat : ${segments}">
        <td th:text="${stat.index+1}">1</td>
        <td th:text="${seg.start}">0.0</td>
        <td th:text="${seg.end}">5.2</td>
        <td th:text="${seg.text}">자막</td>
        <td><button type="button" class="btn btn-primary" th:onclick="'videoSeek('+${seg.start}+')';">▶︎</button></td>
      </tr>
      </tbody>
    </table>
  </section>

  <p><a th:href="@{/lecture/upload}">다시 업로드</a></p>
</div>

<!-- ─────────────────────────  JS: 진도/검색/토글/마커  ───────────────────────── -->
<script th:inline="javascript">
/*<![CDATA[*/
const segments   = /*[[${segments}]]*/ [];
const savedPct   = /*[[${videoPct}]]*/ 0;
const video      = document.getElementById('videoPlayer');
const overlay    = document.getElementById('markerOverlay');
const videoNo    = Number(video.dataset.videoNo);
const infoSec    = document.getElementById('infoSection');
const toggleBtn  = document.getElementById('toggleInfoBtn');
let infoVisible  = false;

// ───────── 정보 토글 ─────────
function toggleInfo(){
  infoVisible = !infoVisible;
  infoSec.style.display = infoVisible ? 'block' : 'none';
  toggleBtn.textContent = infoVisible ? '추가 정보 숨기기' : '추가 정보 보기';
}

// ───────── 재생 위치 복원 ─────────
function initResume(){
  if(savedPct>0 && video.duration){
    let resumeTime = video.duration*savedPct/100;
    if(resumeTime>video.duration) resumeTime = video.duration-0.5;
    video.currentTime = resumeTime;
  }
}

/* 공통 fetch 함수 */
function sendProgress(pct){
  fetch('/api/progress/save',{method:'POST',headers:{'Content-Type':'application/json'},
         body:JSON.stringify({videoNo,progress:pct})}).catch(console.error);
}

// ───────── 진행률 전송 ─────────
let lastSentTime = 0;
const intervalSec = 5;
function reportProgress(){
  if(!video.duration) return;
  const now = video.currentTime;
  if(now - lastSentTime < intervalSec) return;

  const pct = Math.floor(now/video.duration*100);
  lastSentTime = now;
  sendProgress(pct);

  if(pct>=99){ sendProgress(100); }
}

// 재생 완료 시 100% 저장
video.addEventListener('ended', ()=> sendProgress(100));

// ───────── 시킹/마커 ─────────
function videoSeek(t){ video.currentTime=t; video.play(); }
function clearMarkers(){ overlay.innerHTML=''; }

// ───────── 키워드 검색 ─────────
function searchKeyword(){
  const kw = document.getElementById('keywordInput').value.trim().toLowerCase();
  const resDiv = document.getElementById('searchResults');
  resDiv.innerHTML=''; clearMarkers();

  if(!kw){ resDiv.textContent='검색어를 입력하세요.'; return; }

  let found=0;
  segments.forEach((seg,i)=>{
    const txt = (seg.text||'').toLowerCase();
    if(txt.includes(kw)){
      found++;
      const row = document.createElement('div'); row.style.marginBottom='8px';
      const btn = document.createElement('button'); btn.className='btn btn-primary';
      btn.textContent=`${i+1}번 (${seg.start.toFixed(1)}s)`;
      btn.onclick=()=>videoSeek(seg.start);
      row.appendChild(btn);
      row.append(`  ${seg.text}`);
      resDiv.appendChild(row);

      const dur = video.duration||1;
      const marker = document.createElement('div'); marker.className='marker';
      marker.style.left=`calc(${(seg.start/dur)*100}% - 4px)`;
      marker.title=seg.text;
      marker.onclick=()=>videoSeek(seg.start);
      overlay.appendChild(marker);
    }
  });
  if(!found) resDiv.textContent='해당 키워드가 없습니다.';
}
/*]]>*/
</script>
</body>
</html>