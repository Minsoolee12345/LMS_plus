<!-- lecture_watch.html (업로드 페이지 디버깅 추가) -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>강의 영상 업로드</title>

  <!-- 공통 head 프래그먼트 삽입 -->
  <th:block th:insert="~{layout :: head}"></th:block>

  <!-- Bootstrap 3 CSS (프로젝트에 이미 포함돼 있으면 제거) -->
  <link rel="stylesheet"
        href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">

  <style>
    /* ───────── 레이아웃 & 타이포 ───────── */
    body{font-family:"Helvetica Neue",Arial,sans-serif;padding:20px;background:#f9f9fb}
    label,select,input[type="file"]{width:100%;box-sizing:border-box;margin-top:10px}

    .container{max-width:820px;margin:0 auto}
    .row{display:flex;flex-wrap:wrap}
    .content{flex:1 1 100%}

    /* ───────── 색상: Bootstrap primary (#337ab7) 적용 ───────── */
    :root{
      --bs-primary:#337ab7;
      --bs-primary-dark:#2e6da4;
    }

    /* 패널 */
    .panel{border:1px solid var(--bs-primary);border-radius:6px}
    .panel-heading{background:var(--bs-primary);color:#fff;padding:12px 16px;font-size:1.2rem}
    .panel-body{padding:24px 16px}
    hr{margin:24px 0}

    /* 셀렉트박스 */
    .custom-select{padding:8px 12px;border:1px solid #ddd;border-radius:4px}

    /* 파일 선택 영역 */
    .image-preview{display:flex;align-items:center;gap:8px}
    .image-preview .btn{position:relative;overflow:hidden}
    .image-preview .btn input[type="file"]{
      position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer
    }
    .file-name{font-weight:600;color:var(--bs-primary)}

    /* 업로드 버튼 */
    .btn-outline-primary{
      color:var(--bs-primary);
      border:2px solid var(--bs-primary);
      background:#fff;
      transition:all .25s
    }
    .btn-outline-primary:hover{
      color:#fff;
      background:var(--bs-primary);
      border-color:var(--bs-primary-dark)
    }

    /* 모달 & 스피너 */
    #spinner{border:8px solid #f3f3f3!important;border-top:8px solid var(--bs-primary)!important;
             border-radius:50%!important;width:80px!important;height:80px!important;
             animation:spin 1s linear infinite;margin:0 auto;display:none}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

    #statusContainer{display:none;align-items:center;margin-top:15px}
    #statusMessage{font-weight:600;color:var(--bs-primary);min-width:150px}

    @media(max-width:600px){
      .panel-body{padding:16px 12px}
      .btn-outline-primary{width:100%}
    }
  </style>
</head>

<body>
  <div th:replace="~{layout :: header}"></div>

  <div class="container">
    <div class="row">
      <div class="content">

        <div class="panel">
          <div class="panel-heading">강의 영상 업로드</div>

          <div class="panel-body">
            <form id="uploadForm"
                  th:action="@{/lecture/upload}"
                  method="post"
                  enctype="multipart/form-data">

              <!-- 강의 선택 -->
              <label for="lectureNo">강의 선택:</label>
              <select id="lectureNo" name="lectureNo" class="custom-select" required>
                <option disabled selected value="">-- 업로드할 강의를 선택하세요 --</option>
                <option th:each="lec : ${lectures}"
                        th:value="${lec.lectureNo}"
                        th:text="${lec.title}">강의 제목</option>
              </select>

              <!-- 파일 선택 -->
              <label for="file">업로드할 영상 파일 선택:</label>
              <div class="input-group image-preview">
                <div class="btn btn-outline-primary">
                  파일 선택
                  <input type="file" id="file" name="file" accept="video/*" required>
                </div>
                <span id="fileName" class="file-name">선택된 파일 없음</span>
              </div>

              <!-- 공개 여부 -->
              <label for="visibility">공개 여부:</label>
              <select id="visibility" name="visibility">
                <option value="1" selected>전체 공개</option>
                <option value="0">비공개</option>
              </select>

              <!-- 업로드 버튼 -->
              <button type="submit" class="btn btn-outline-primary" style="margin-top:20px">
                업로드 및 분석
              </button>
            </form>

            <!-- 상태 영역 -->
            <div id="statusContainer">
              <div id="statusMessage"></div>
              <div id="spinner"></div>
            </div>
          </div>
        </div><!-- /.panel -->

      </div>
    </div>
  </div><!-- /.container -->

  <!-- 업로드 진행 스크립트 -->
  <script>
    console.log('lecture_watch.html: 스크립트 로드됨');
    const form         = document.getElementById('uploadForm');
    const statusEl     = document.getElementById('statusMessage');
    const spinner      = document.getElementById('spinner');
    const container    = document.getElementById('statusContainer');
    const fileInput    = document.getElementById('file');
    const fileNameEl   = document.getElementById('fileName');
    let ellipsisInterval;

    /* 선택된 파일명 출력 */
    fileInput.addEventListener('change', () => {
      console.log('fileInput change event:', fileInput.files);
      if (fileInput.files.length){
        fileNameEl.textContent = fileInput.files[0].name;
        console.log('선택된 파일명:', fileInput.files[0].name);
      } else {
        fileNameEl.textContent = '선택된 파일 없음';
      }
    });

    form.addEventListener('submit', e => {
      e.preventDefault();
      console.log('uploadForm submit prevented, 시작');

      /* 상태 영역·스피너 노출 */
      container.style.display = 'flex';
      spinner.style.display   = 'block';
      statusEl.textContent    = '업로드 중';
      console.log('업로드 상태:', statusEl.textContent);

      let dot = 0;
      ellipsisInterval = setInterval(() => {
        dot = (dot + 1) % 4;
        statusEl.textContent = '업로드 중' + '.'.repeat(dot);
      }, 500);

      const xhr = new XMLHttpRequest();
      xhr.open('POST', form.action);

      xhr.onload = () => {
        clearInterval(ellipsisInterval);
        spinner.style.display   = 'none';
        container.style.display = 'none';
        console.log('XHR onload, responseURL:', xhr.responseURL);
        window.location.href    = xhr.responseURL;
      };
      xhr.onerror = () => {
        clearInterval(ellipsisInterval);
        spinner.style.display   = 'none';
        statusEl.textContent    = '업로드 중 오류가 발생했습니다.';
        console.error('XHR onerror 발생');
      };

      console.log('XHRSend:', form.action);
      xhr.send(new FormData(form));
    });
  </script>
</body>
</html>